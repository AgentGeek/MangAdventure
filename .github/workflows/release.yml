name: Release

on:
  push:
    tags: ['*']

jobs:
  codeql:
    name: "CodeQL"
    runs-on: ubuntu-latest
    if: github.repository_owner == 'mangadventure'
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v2
      - name: "Initialize CodeQL"
        uses: github/codeql-action/init@v1
        with:
          languages: javascript, python
      - name: "Perform CodeQL Analysis"
        uses: github/codeql-action/analyze@v1

  release:
    name: "Create release"
    needs: [codeql]
    runs-on: ubuntu-latest
    if: github.repository_owner == 'mangadventure'
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v2
      - name: "Verify release version"
        run: >-
          grep -q "__version__ = '${GITHUB_REF##*/v}'" MangAdventure/__init__.py &&
          grep -q "@${GITHUB_REF##*/}#egg=mangadventure\"" docs/install.rst &&
          grep -q "@${GITHUB_REF##*/}#egg=mangadventure\[" docs/install.rst &&
          grep -q "^${GITHUB_REF##*/}$" docs/changelog.rst
      - name: "Parse release body"
        run: make changes > changes.md
        working-directory: ./docs
        if: success()
      - name: "Upload release"
        uses: ncipollo/release-action@v1
        if: success()
        with:
          token: ${{secrets.GITHUB_TOKEN}}
          bodyFile: docs/changes.md
          allowUpdates: true
